rules:
  - id: flask-missing-auth
    languages: [python]
    message: "⚠️ Flask route may be missing authorization check"
    severity: WARNING
    patterns:
      # Flask route decorators without explicit auth checks
      - pattern: |
          @app.route($ROUTE)
          def $FUNC(...):
            ...
      - pattern: |
          @$APP.route($ROUTE)
          def $FUNC(...):
            ...
      # Flask routes with methods but no auth
      - pattern: |
          @app.route($ROUTE, methods=[$METHODS])
          def $FUNC(...):
            ...
      - pattern: |
          @$APP.route($ROUTE, methods=[$METHODS])
          def $FUNC(...):
            ...
      # Blueprint routes without auth
      - pattern: |
          @$BLUEPRINT.route($ROUTE)
          def $FUNC(...):
            ...
      - pattern: |
          @$BLUEPRINT.route($ROUTE, methods=[$METHODS])
          def $FUNC(...):
            ...
    # Exclude routes that already have auth decorators
    pattern-not-inside:
      - pattern: |
          @login_required
          @app.route(...)
          def $FUNC(...):
            ...
      - pattern: |
          @auth.login_required
          @app.route(...)
          def $FUNC(...):
            ...
      - pattern: |
          @requires_auth
          @app.route(...)
          def $FUNC(...):
            ...
      - pattern: |
          @jwt_required
          @app.route(...)
          def $FUNC(...):
            ...
      - pattern: |
          @admin_required
          @app.route(...)
          def $FUNC(...):
            ...
    # Exclude common public routes
    pattern-not:
      - pattern: |
          @app.route("/")
          def $FUNC(...):
            ...
      - pattern: |
          @app.route("/health")
          def $FUNC(...):
            ...
      - pattern: |
          @app.route("/status")
          def $FUNC(...):
            ...
      - pattern: |
          @app.route("/login")
          def $FUNC(...):
            ...
      - pattern: |
          @app.route("/register")
          def $FUNC(...):
            ...
      - pattern: |
          @app.route("/public")
          def $FUNC(...):
            ...
    metadata:
      category: security
      subcategory: missing-auth
      technology:
        - flask
        - python
      references:
        - https://flask-login.readthedocs.io/en/latest/
        - https://flask-httpauth.readthedocs.io/en/latest/
      cwe: "CWE-862: Missing Authorization"
      owasp: "A01:2021 - Broken Access Control"
